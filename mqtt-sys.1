.\" mqtt-sys.1:
.\"
.\" This file is a part of the mqtt-sys package by Jan-Piet Mens
.\"
.TH mqtt-sys 1 "May 2015"
.SH NAME
mqtt-sys \- MQTT "$SYS/#"-subscriber for collectd exec
.SH SYNOPSYS
.B mqtt-sys [-h
.I host
.B ]
.B [-p
.I port
.B ] [-C
.I CA-cert
.B ] [-u
.I username
.B ] [-P
.I password
.B ] [-K
.I psk-key
.B ] [-I
.I psk-identity
.B ] [-s] [-N
.I nodename
.B ] [-f
.I metrics
.B ] [-t
.I topic...
.B ]

.SH DESCRIPTION

.I mqtt-sys
is an executable program which is used with
.IR collectd (1).
It subscribes to the MQTT $SYS/# topic and/or any number of topics
you specify, and prints values to
.I stdout
for
.I collectd
to process in an
.I exec
plugin block.

.SS "MQTT subscriptions"

By default,
.I mqtt-sys
subscribes to the $SYS/# topic tree of the specified MQTT broker, but any number of topic subscriptions can be set up using
.BR -t .
Whether or not the payload of a received message is actually passed to
.I collectd
is defined by a
.I metrics map
which maps an MQTT topic name to a metric name with a particular type (and value). It is thus
possible that
.I mqtt-sys
is subscribed to a topic but doesn't pass that to
.IR collectd .

.SS "Metrics map"

The MQTT 
.I topic
to 
.I collectd metrics
mapping is configured through a 
.I metrics
file you provide. Lines which start with # and empty lines are ignored.
All other lines must have three white-space separated tokens. 
The
.I metric name
which is what is passed to
.IR collectd ,
the
.I type
of the metric (from 
.IR types.db ),
and the MQTT
.IR "topic name" .
.PP
.nf
temp.living        gauge   arduino/temp/celsius
bROKER.UPTIme      uptime  $SYS/broker/uptime
msgs.count         gauge   $SYS/broker/retained messages/count`
.fi
.PP

.SS influxdb

Configure InfluxDB to launch the native collect input:

.nf
[input_plugins]

  # Configure the collectd api
  [input_plugins.collectd]
  enabled = true
  # address = "0.0.0.0" # If not set, is actually set to bind-address.
  port = 25826
  database = "collectd"
  # types.db can be found in a collectd installation or on github:
  # https://github.com/collectd/collectd/blob/master/src/types.db
  typesdb = "/usr/share/collectd/types.db" # The path to the collectd types.db file
.fi

.SS collectd

Configure collectd to send its metrics to InfluxDB via the _network_ plugin which talks to InfluxDB. (Compare the port numbers here and above in InfluxDB.)

.nf
LoadPlugin network

<Plugin "network">
  # influxdb
    Server "127.0.0.1" "25826"
</Plugin>
.fi

Configure collectd to load our executable via the _exec_ mechanism. Specify options as you need them.

.nf
LoadPlugin exec

<Plugin exec>
   Exec "mosquitto:mosquitto" "/usr/bin/mqtt-sys" "-u" "jjolie" "-P" "secret" "-f" "/etc/metrics"
</Plugin>
.fi

.SS Testing

To see if whether your values are being passed to InfluxDB:

.nf
select * from "hippo/mqtt-sys/connections-connections.1m"
select * from "hippo/mqtt-sys/counter-msgs.received"
.fi

.SH OPTIONS

.IP "\fB\-C\fR \fIca-file\fR"
specifies the PEM-encoded CA certificate file to use for TLS.

.IP "\fB\-h \fIhost\fR"
is the hostname or address of the MQTT broker. Unless overriden by
.B -N
this also sets the collectd
.IR nodename .

.IP "\fB\-p \fIport\fR"
gives the TCP port number for the MQTT broker; defaults to 1883.

.IP "\fB\-s\fR"
use insecure TLS.

.IP "\fB\-f \fImetrics\fR"
is the path to the metrics file which defaults to "./metrics". If 
this file cannot be read, the program exits with a diagnostic
message.

.IP "\fB\-I \fIpsk-identity\fR"
sets the identity for PSK.

.IP "\fB\-t \fItopic\fR"
may be specified multiple times and causes 
.I mqtt-sys
to subscribe to that topic. Defaults to "$SYS/#" if not specified.

.IP "\fB\-u  \fIusername\fR"
for the MQTT connection.

.IP "\fB\-P  \fIpassword\fR"
for the MQTT connection.

.IP "\fB\-K  \fIpsk-key\fR"
for the MQTT connection.


.IP "\fB\-N  \fInodename\fR"
Overrides the
.IR collectd
node name, which without this option, defaults to the short local hostname or the value of the
.B -h
option

.SH AUTHOR

Jan-Piet Mens

.SH "SEE ALSO"

.IR collectd (1),
.IR mosquitto (8)
.IR uthash (http://troydhanson.github.io/uthash/userguide.html)

